pipeline {
    agent any

    stages {

        stage("Checkout code") {
            steps {
                git branch: 'sarah-feature', url: 'https://github.com/sarah254-tech/React-ToDoList.git'
            }
        }

        stage("Build image and push") {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
                ]) {

                    sh '''
                        echo "Logging in to DockerHub..."
                        echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin

                        echo "Building backend image..."
                        docker build -t $USERNAME/ci_backend_full_pipeline:v1 -f backend/Dockerfile backend

                        echo "Building frontend image..."
                        docker build -t $USERNAME/ci_frontend_full_pipeline:v1 -f dive-react-app/Dockerfile dive-react-app

                        echo "Pushing images..."
                        docker push $USERNAME/ci_backend_full_pipeline:v1
                        docker push $USERNAME/ci_frontend_full_pipeline:v1
                    '''
                }
            }
        }

        stage("Deploy to EC2") {
            steps {
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'EC2_KEY', keyFileVariable: 'SSH_KEY'),
                    string(credentialsId: 'EC2_HOST', variable: 'EC2_HOST'),
                    usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
             ]) {

                sh '''
                     # Make SSH key secure
                    chmod 600 $SSH_KEY

                    # SSH into EC2
                    ssh -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$EC2_HOST << 'EOF'
                    echo "Connected to EC2"

                    # Set environment variables for DockerHub
                    export USERNAME="$USERNAME"
                    export PASSWORD="$PASSWORD"

                    # Directory for the React-ToDoList app
                    APP_DIR="/home/ubuntu/React-ToDoList"

                    # Check if app directory exists
                    if [ ! -d "$APP_DIR" ]; then
                        mkdir -p "$APP_DIR"
                    fi
                    cd "$APP_DIR"

                    # Configure a dedicated SSH key for GitHub (EC2 deployment key)
                    DEPLOY_KEY="$APP_DIR/id_ed25519_ec2"
                    if [ ! -f "$DEPLOY_KEY" ]; then
                        ssh-keygen -t ed25519 -C "ec2-instance" -f "$DEPLOY_KEY" -N ""
                        echo "Please add the public key to GitHub:"
                        cat "$DEPLOY_KEY.pub"
                        echo "Cloning will fail until the key is added to GitHub"
                        exit 1
                    fi

                    # Configure SSH to use this key for GitHub
                    mkdir -p ~/.ssh
                    echo "Host github-ec2
                        HostName github.com
                        User git
                        IdentityFile $DEPLOY_KEY
                        StrictHostKeyChecking no" > ~/.ssh/config
                    chmod 600 ~/.ssh/config

                    # Clone or pull the repo using the dedicated key
                    if [ ! -d "React-ToDoList" ]; then
                        git clone git@github-ec2:sarah254-tech/React-ToDoList.git .
                    else
                        git -C . pull
                    fi

                    # Make deploy.sh executable
                    if [ -f "deploy.sh" ]; then
                        chmod +x deploy.sh
                        bash deploy.sh
                    else
                        echo "Error: deploy.sh not found"
                        exit 1
                    fi
EOF
            '''
                }
            }
        }

    } 
}    


